<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø£Ø³Ø¯ Ø§Ù„Ù…Ù„ÙŠÙˆÙ† Ø§Ù„Ø£Ø®ÙŠØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <style> h
    Telegraf, Markup } from 'telegraf';
import dotenv from 'dotenv';
import fs from 'fs';

dotenv.config();

// ============================================
// ğŸ—„ï¸ Ù†Ø¸Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø³ÙŠØ· (JSON)
// ============================================
class SimpleDB {
  constructor(filename = 'data.json') {
    this.filename = filename;
    this.data = this.load();
  }

  load() {
    try {
      if (fs.existsSync(this.filename)) {
        const raw = fs.readFileSync(this.filename, 'utf8');
        return JSON.parse(raw);
      }
    } catch (error) {
      console.error('Error loading database:', error);
    }
    return { players: {}, posts: [], sessions: [] };
  }

  save() {
    try {
      fs.writeFileSync(this.filename, JSON.stringify(this.data, null, 2));
    } catch (error) {
      console.error('Error saving database:', error);
    }
  }

  getPlayer(telegramId) {
    return this.data.players[telegramId];
  }

  createPlayer(telegramId, username) {
    this.data.players[telegramId] = {
      telegramId,
      username,
      characterType: 'cub',
      zaarBalance: 0,
      energy: 1000,
      lastEnergyUpdate: Date.now(),
      totalMined: 0,
      miningStreak: 0,
      lastMiningTime: null,
      evolutionProgress: 0,
      hasEvolved: false,
      postsCount: 0,
      likesReceived: 0,
      createdAt: Date.now(),
    };
    this.save();
    return this.data.players[telegramId];
  }

  updatePlayer(telegramId, updates) {
    if (this.data.players[telegramId]) {
      this.data.players[telegramId] = {
        ...this.data.players[telegramId],
        ...updates,
      };
      this.save();
    }
  }

  addMiningSession(telegramId, session) {
    this.data.sessions.push({
      telegramId,
      ...session,
      timestamp: Date.now(),
    });
    this.save();
  }

  getRecentMining(telegramId, hoursAgo = 1) {
    const timeLimit = Date.now() - hoursAgo * 60 * 60 * 1000;
    return this.data.sessions.filter(
      (s) => s.telegramId === telegramId && s.timestamp > timeLimit
    );
  }

  addPost(post) {
    this.data.posts.push({
      id: Date.now().toString(),
      ...post,
      likesCount: 0,
      createdAt: Date.now(),
    });
    this.save();
  }

  getPosts(limit = 10) {
    return this.data.posts
      .sort((a, b) => b.createdAt - a.createdAt)
      .slice(0, limit);
  }
}

// ============================================
// âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
// ============================================
const CONFIG = {
  MINING_DURATION: 15, // Ø«Ø§Ù†ÙŠØ©
  ENERGY_PER_MINE: 10,
  ENERGY_MAX: 1000,
  ENERGY_REGEN_PER_HOUR: 100,
  ZAAR_TO_EVOLVE: 1000,
  BASE_REWARD: 10,
  MAX_ZAAR_PER_HOUR: 5000,
};

// ============================================
// ğŸ® Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©
// ============================================
class GameEngine {
  constructor(db) {
    this.db = db;
    this.activeMining = new Map(); // Ù„Ù„ØªØªØ¨Ø¹ Ù…Ù† ÙŠØ­ÙØ± Ø§Ù„Ø¢Ù†
  }

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  calculateEnergy(player) {
    const timePassed = Date.now() - player.lastEnergyUpdate;
    const hoursPass = timePassed / (1000 * 60 * 60);
    const regenEnergy = Math.floor(hoursPass * CONFIG.ENERGY_REGEN_PER_HOUR);
    const currentEnergy = Math.min(
      CONFIG.ENERGY_MAX,
      player.energy + regenEnergy
    );
    return currentEnergy;
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø¶Ø¨Ø§Ø¹
  checkHyenaAttack(telegramId) {
    const recentSessions = this.db.getRecentMining(telegramId, 1);
    const totalMined = recentSessions.reduce((sum, s) => sum + s.zaarMined, 0);
    return totalMined > CONFIG.MAX_ZAAR_PER_HOUR;
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ†
  async startMining(telegramId) {
    const player = this.db.getPlayer(telegramId);
    if (!player) {
      return { success: false, error: 'PLAYER_NOT_FOUND' };
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©
    if (this.activeMining.has(telegramId)) {
      return { success: false, error: 'ALREADY_MINING' };
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù‚Ø©
    const currentEnergy = this.calculateEnergy(player);
    if (currentEnergy < CONFIG.ENERGY_PER_MINE) {
      return {
        success: false,
        error: 'NOT_ENOUGH_ENERGY',
        currentEnergy,
      };
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ†
    this.activeMining.set(telegramId, {
      startTime: Date.now(),
      energyBefore: currentEnergy,
    });

    // Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¯Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ† (15 Ø«Ø§Ù†ÙŠØ©)
    await new Promise((resolve) =>
      setTimeout(resolve, CONFIG.MINING_DURATION * 1000)
    );

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
    const baseReward = CONFIG.BASE_REWARD;
    const multiplier = player.hasEvolved ? 2 : 1;
    let zaarMined = Math.floor(baseReward * multiplier);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø¶Ø¨Ø§Ø¹
    const hyenaAttack = this.checkHyenaAttack(telegramId);
    if (hyenaAttack) {
      zaarMined = Math.floor(zaarMined * 0.5);
    }

    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨
    const newEnergy = currentEnergy - CONFIG.ENERGY_PER_MINE;
    const newProgress = player.evolutionProgress + 1;

    this.db.updatePlayer(telegramId, {
      zaarBalance: player.zaarBalance + zaarMined,
      energy: newEnergy,
      lastEnergyUpdate: Date.now(),
      totalMined: player.totalMined + zaarMined,
      lastMiningTime: Date.now(),
      miningStreak: player.miningStreak + 1,
      evolutionProgress: newProgress,
    });

    // Ø­ÙØ¸ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ†
    this.db.addMiningSession(telegramId, {
      zaarMined,
      energyUsed: CONFIG.ENERGY_PER_MINE,
      hyenaAttack,
    });

    // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    this.activeMining.delete(telegramId);

    return {
      success: true,
      zaarMined,
      energyRemaining: newEnergy,
      hyenaAttack,
      evolutionProgress: newProgress,
      canEvolve: newProgress >= CONFIG.ZAAR_TO_EVOLVE && !player.hasEvolved,
    };
  }

  // ØªØ·ÙˆØ± Ø§Ù„Ø´Ø¨Ù„ Ø¥Ù„Ù‰ Ø£Ø³Ø¯
  evolve(telegramId) {
    const player = this.db.getPlayer(telegramId);
    if (!player) {
      return { success: false, error: 'PLAYER_NOT_FOUND' };
    }

    if (player.hasEvolved) {
      return { success: false, error: 'ALREADY_EVOLVED' };
    }

    if (player.evolutionProgress < CONFIG.ZAAR_TO_EVOLVE) {
      return { success: false, error: 'NOT_ENOUGH_PROGRESS' };
    }

    // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ·ÙˆØ±
    const evolutionBonus = 100;
    this.db.updatePlayer(telegramId, {
      characterType: 'lion',
      hasEvolved: true,
      energy: CONFIG.ENERGY_MAX, // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù„Ø¡ Ø§Ù„Ø·Ø§Ù‚Ø©
      zaarBalance: player.zaarBalance + evolutionBonus,
    });

    return {
      success: true,
      bonus: evolutionBonus,
    };
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±
  createPost(telegramId, content) {
    const player = this.db.getPlayer(telegramId);
    if (!player) {
      return { success: false, error: 'PLAYER_NOT_FOUND' };
    }

    this.db.addPost({
      telegramId,
      username: player.username || 'Ù…Ø¬Ù‡ÙˆÙ„',
      characterType: player.characterType,
      content,
    });

    // Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù†Ø´Ø±
    this.db.updatePlayer(telegramId, {
      postsCount: player.postsCount + 1,
      zaarBalance: player.zaarBalance + 5,
    });

    return { success: true, reward: 5 };
  }
}

// ============================================
// ğŸ¤– Ø§Ù„Ø¨ÙˆØª
// ============================================
const bot = new Telegraf(process.env.BOT_TOKEN);
const db = new SimpleDB();
const game = new GameEngine(db);

// Ø§Ù„Ø£Ù…Ø±: /start - Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ© Ø§Ù„Ù…Ù‡ÙŠØ¨Ø©
bot.command('start', async (ctx) => {
  const telegramId = ctx.from.id.toString();
  let player = db.getPlayer(telegramId);

  if (!player) {
    player = db.createPlayer(telegramId, ctx.from.username);
  }

  const welcomeText = `
ğŸ¦ *Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ø¹Ø§Ù„Ù… LAST* ğŸ¦

ÙÙŠ ØºØ§Ø¨Ø© Ù…Ø¸Ù„Ù…Ø©... Ø´Ø¨Ù„ ÙˆØ­ÙŠØ¯ ÙŠØ±ØªØ¬Ù Ù…Ù† Ø§Ù„Ø¨Ø±Ø¯ â„ï¸
Ù„ÙƒÙ† Ù‚Ø¯Ø±Ù‡ Ø£Ù† ÙŠØµØ¨Ø­ Ù…Ù„Ùƒ Ø§Ù„ØºØ§Ø¨Ø©! ğŸ‘‘

ğŸ¯ *Ø±Ø­Ù„ØªÙƒ:*
â€¢ Ø§Ø­ÙØ± Ù„ØªØ¬Ù…Ø¹ Ø¹Ù…Ù„Ø§Øª ZAAR ğŸ’
â€¢ Ø§Ø¬Ù…Ø¹ 1000 ZAAR Ù„ØªØªØ·ÙˆØ± Ø¥Ù„Ù‰ Ø£Ø³Ø¯ ğŸ¦
â€¢ Ø´Ø§Ø±Ùƒ ÙÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© ğŸŒŠ
â€¢ ÙˆØ§ØµÙ„ Ø­ØªÙ‰ ØªØµØ¨Ø­ Ø§Ù„Ù…Ù„Ùƒ! ğŸ‘‘

âš¡ Ø§Ù„Ø·Ø§Ù‚Ø©: ${player.energy}/${CONFIG.ENERGY_MAX}
ğŸ’ ZAAR: ${player.zaarBalance}

ğŸ® *Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:*
/mine - Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­ÙØ± â›ï¸
/stats - Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ ğŸ“Š
/evolve - ØªØ·ÙˆØ± Ø¥Ù„Ù‰ Ø£Ø³Ø¯ (Ø¹Ù†Ø¯ 1000 ZAAR)
/lake - Ø§Ù„Ø¨Ø­ÙŠØ±Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© ğŸŒŠ
/help - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© â“
`;

  await ctx.replyWithMarkdown(welcomeText, {
    reply_markup: {
      keyboard: [
        ['â›ï¸ Ø§Ø­ÙØ± Ø§Ù„Ø¢Ù†', 'ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ'],
        ['ğŸ¦ ØªØ·ÙˆØ±', 'ğŸŒŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ø©'],
        ['â“ Ù…Ø³Ø§Ø¹Ø¯Ø©'],
      ],
      resize_keyboard: true,
    },
  });
});

// Ø§Ù„Ø£Ù…Ø±: /mine - Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ†
bot.command('mine', async (ctx) => {
  const telegramId = ctx.from.id.toString();
  const player = db.getPlayer(telegramId);

  if (!player) {
    return ctx.reply('Ø§Ø³ØªØ®Ø¯Ù… /start Ø£ÙˆÙ„Ø§Ù‹! âœ¨');
  }

  const currentEnergy = game.calculateEnergy(player);

  if (currentEnergy < CONFIG.ENERGY_PER_MINE) {
    return ctx.reply(
      `âš ï¸ Ø·Ø§Ù‚ØªÙƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ©!\n\n` +
        `âš¡ Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${currentEnergy}/${CONFIG.ENERGY_MAX}\n` +
        `ğŸ“ˆ ØªØªØ¬Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ø© Ø¨Ù…Ø¹Ø¯Ù„ ${CONFIG.ENERGY_REGEN_PER_HOUR} ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø©\n\n` +
        `â° Ø¹Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹!`
    );
  }

  const statusMsg = await ctx.reply(
    `â›ï¸ *Ø¨Ø¯Ø£ Ø§Ù„Ø­ÙØ±...*\n\n` +
      `${player.characterType === 'cub' ? 'ğŸ¾' : 'ğŸ¦'} Ø§Ù„Ø´Ø¨Ù„ ÙŠØ­ÙØ± Ø¨Ù‚ÙˆØ©!\n` +
      `â³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${CONFIG.MINING_DURATION} Ø«Ø§Ù†ÙŠØ©...\n\n` +
      `ğŸ’ª Ø§Ø³ØªÙ…Ø±!`,
    { parse_mode: 'Markdown' }
  );

  // Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ
  for (let i = CONFIG.MINING_DURATION; i > 0; i -= 5) {
    await new Promise((resolve) => setTimeout(resolve, 5000));
    try {
      await ctx.telegram.editMessageText(
        ctx.chat.id,
        statusMsg.message_id,
        null,
        `â›ï¸ *Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ±...*\n\n` +
          `${player.characterType === 'cub' ? 'ğŸ¾' : 'ğŸ¦'} Ø§Ù„Ø´Ø¨Ù„ ÙŠØ­ÙØ± Ø¨Ù‚ÙˆØ©!\n` +
          `â³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${i - 5} Ø«Ø§Ù†ÙŠØ©...\n\n` +
          `ğŸ’ª Ø§Ø³ØªÙ…Ø±!`,
        { parse_mode: 'Markdown' }
      );
    } catch (e) {
      // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠØ±
    }
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ†
  const result = await game.startMining(telegramId);

  if (result.success) {
    let resultText = `
âœ¨ *Ù†Ø¬Ø­ Ø§Ù„Ø­ÙØ±!* âœ¨

ğŸ’ Ø­ØµÙ„Øª Ø¹Ù„Ù‰: *${result.zaarMined} ZAAR*
${result.hyenaAttack ? 'âš ï¸ Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø¶Ø¨Ø§Ø¹! ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¨Ù†Ø³Ø¨Ø© 50%' : ''}

ğŸ“Š *Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø¢Ù†:*
ğŸ’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ZAAR: ${db.getPlayer(telegramId).zaarBalance}
âš¡ Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${result.energyRemaining}/${CONFIG.ENERGY_MAX}
ğŸ“ˆ ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ·ÙˆØ±: ${result.evolutionProgress}/${CONFIG.ZAAR_TO_EVOLVE}
`;

    if (result.canEvolve) {
      resultText += `\nğŸ‰ *ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ·ÙˆØ± Ø§Ù„Ø¢Ù†!*\nØ§Ø³ØªØ®Ø¯Ù… /evolve Ù„Ù„ØªØ·ÙˆØ± Ø¥Ù„Ù‰ Ø£Ø³Ø¯! ğŸ¦`;
    }

    await ctx.telegram.editMessageText(
      ctx.chat.id,
      statusMsg.message_id,
      null,
      resultText,
      { parse_mode: 'Markdown' }
    );
  } else {
    await ctx.reply(`âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${result.error}`);
  }
});

// Ø²Ø± Ø§Ù„Ø­ÙØ±
bot.hears('â›ï¸ Ø§Ø­ÙØ± Ø§Ù„Ø¢Ù†', (ctx) => ctx.telegram.sendMessage(ctx.chat.id, 'Ø§Ø³ØªØ®Ø¯Ù… /mine Ù„Ù„Ø­ÙØ±!'));

// Ø§Ù„Ø£Ù…Ø±: /stats - Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
bot.command('stats', async (ctx) => {
  const telegramId = ctx.from.id.toString();
  const player = db.getPlayer(telegramId);

  if (!player) {
    return ctx.reply('Ø§Ø³ØªØ®Ø¯Ù… /start Ø£ÙˆÙ„Ø§Ù‹! âœ¨');
  }

  const currentEnergy = game.calculateEnergy(player);
  const progressPercent = (
    (player.evolutionProgress / CONFIG.ZAAR_TO_EVOLVE) *
    100
  ).toFixed(1);

  const statsText = `
ğŸ“Š *Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${player.username || 'Ø§Ù„Ù„Ø§Ø¹Ø¨'}* ğŸ“Š

ğŸ¦ *Ø§Ù„Ø­Ø§Ù„Ø©:*
â€¢ Ø§Ù„Ø´Ø®ØµÙŠØ©: ${player.characterType === 'cub' ? 'Ø´Ø¨Ù„ ğŸ¾' : 'Ø£Ø³Ø¯ ğŸ¦'}
â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${player.hasEvolved ? 'Ù…ØªØ·ÙˆØ± âœ¨' : 'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù„Ù„ØªØ·ÙˆØ± ğŸŒ±'}

ğŸ’ *Ø§Ù„Ù…ÙƒØ§Ø³Ø¨:*
â€¢ Ø±ØµÙŠØ¯ ZAAR: ${player.zaarBalance}
â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§ ØªÙ… Ø­ÙØ±Ù‡: ${player.totalMined}
â€¢ Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø­ÙØ±: ${player.miningStreak}

âš¡ *Ø§Ù„Ø·Ø§Ù‚Ø©:*
â€¢ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${currentEnergy}/${CONFIG.ENERGY_MAX}
â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: ${CONFIG.ENERGY_REGEN_PER_HOUR}/Ø³Ø§Ø¹Ø©

ğŸ“ˆ *Ø§Ù„ØªØ·ÙˆØ±:*
â€¢ Ø§Ù„ØªÙ‚Ø¯Ù…: ${player.evolutionProgress}/${CONFIG.ZAAR_TO_EVOLVE}
â€¢ Ø§Ù„Ù†Ø³Ø¨Ø©: ${progressPercent}%
${
  player.evolutionProgress >= CONFIG.ZAAR_TO_EVOLVE && !player.hasEvolved
    ? '\nğŸ‰ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ·ÙˆØ±! Ø§Ø³ØªØ®Ø¯Ù… /evolve'
    : ''
}

ğŸŒŠ *Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ:*
â€¢ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª: ${player.postsCount}
â€¢ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª: ${player.likesReceived}

â° Ø§Ù†Ø¶Ù…Ù…Øª Ù…Ù†Ø°: ${new Date(player.createdAt).toLocaleDateString('ar')}
`;

  await ctx.replyWithMarkdown(statsText);
});

// Ø²Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
bot.hears('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ', (ctx) => ctx.telegram.sendMessage(ctx.chat.id, 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ...') && ctx.telegram.sendMessage(ctx.chat.id, '/stats'));

// Ø§Ù„Ø£Ù…Ø±: /evolve - Ø§Ù„ØªØ·ÙˆØ±
bot.command('evolve', async (ctx) => {
  const telegramId = ctx.from.id.toString();
  const result = game.evolve(telegramId);

  if (result.success) {
    await ctx.replyWithMarkdown(`
ğŸŠ *ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªØ·ÙˆØ±Øª Ø¥Ù„Ù‰ Ø£Ø³Ø¯!* ğŸ¦

âœ¨ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© ØªØ­Ø·Ù…Øª!
ğŸ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${result.bonus} ZAAR ÙƒÙ…ÙƒØ§ÙØ£Ø© ØªØ·ÙˆØ±!

ğŸ’ª *Ù‚ÙˆØªÙƒ Ø§Ù„Ø¢Ù† Ù…Ø¶Ø§Ø¹ÙØ©!*
â€¢ ÙƒÙ„ Ø­ÙØ±Ø© ØªØ¹Ø·ÙŠÙƒ Ø¶Ø¹Ù ZAAR
â€¢ Ø·Ø§Ù‚ØªÙƒ Ø£ÙØ¹ÙŠØ¯Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰

ğŸ‘‘ Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…Ù„Ùƒ Ø§Ù„ØºØ§Ø¨Ø©!
`);
  } else {
    if (result.error === 'ALREADY_EVOLVED') {
      await ctx.reply('ğŸ¦ Ø£Ù†Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ø³Ø¯!');
    } else if (result.error === 'NOT_ENOUGH_PROGRESS') {
      const player = db.getPlayer(telegramId);
      await ctx.reply(
        `âš ï¸ ØªØ­ØªØ§Ø¬ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† ZAAR!\n\n` +
          `ğŸ“ˆ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${player.evolutionProgress}/${CONFIG.ZAAR_TO_EVOLVE}\n` +
          `ğŸ’ ØªØ­ØªØ§Ø¬: ${CONFIG.ZAAR_TO_EVOLVE - player.evolutionProgress} ZAAR Ø£Ø®Ø±Ù‰`
      );
    }
  }
});

// Ø²Ø± Ø§Ù„ØªØ·ÙˆØ±
bot.hears('ğŸ¦ ØªØ·ÙˆØ±', (ctx) => ctx.telegram.sendMessage(ctx.chat.id, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ·ÙˆØ±...') && ctx.telegram.sendMessage(ctx.chat.id, '/evolve'));

// Ø§Ù„Ø£Ù…Ø±: /lake - Ø§Ù„Ø¨Ø­ÙŠØ±Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©
bot.command('lake', async (ctx) => {
  const posts = db.getPosts(5);

  if (posts.length === 0) {
    return ctx.reply(
      'ğŸŒŠ *Ø§Ù„Ø¨Ø­ÙŠØ±Ø© ÙØ§Ø±ØºØ©!*\n\n' +
        'ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ†Ø´Ø±!\n' +
        'Ø§Ø³ØªØ®Ø¯Ù…: /post Ø±Ø³Ø§Ù„ØªÙƒ',
      { parse_mode: 'Markdown' }
    );
  }

  let lakeText = 'ğŸŒŠ *Ø§Ù„Ø¨Ø­ÙŠØ±Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©* ğŸŒŠ\n\n';

  posts.forEach((post, index) => {
    const icon = post.characterType === 'lion' ? 'ğŸ¦' : 'ğŸ¾';
    lakeText += `${icon} *${post.username}*\n`;
    lakeText += `ğŸ’¬ ${post.content}\n`;
    lakeText += `â¤ï¸ ${post.likesCount} â€¢ ${new Date(post.createdAt).toLocaleString('ar')}\n\n`;
  });

  lakeText += '\nğŸ“ Ù„Ù†Ø´Ø± Ø±Ø³Ø§Ù„ØªÙƒ: /post Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§';

  await ctx.replyWithMarkdown(lakeText);
});

// Ø²Ø± Ø§Ù„Ø¨Ø­ÙŠØ±Ø©
bot.hears('ğŸŒŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ø©', (ctx) => ctx.telegram.sendMessage(ctx.chat.id, '/lake'));

// Ø§Ù„Ø£Ù…Ø±: /post - Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ø©
bot.command('post', async (ctx) => {
  const telegramId = ctx.from.id.toString();
  const content = ctx.message.text.replace('/post', '').trim();

  if (!content) {
    return ctx.reply('Ø§Ø³ØªØ®Ø¯Ù…: /post Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§\n\nÙ…Ø«Ø§Ù„: /post Ø£ÙˆÙ„ ÙŠÙˆÙ… Ù„ÙŠ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©! ğŸ®');
  }

  const result = game.createPost(telegramId, content);

  if (result.success) {
    await ctx.reply(
      `âœ… *ØªÙ… Ù†Ø´Ø± Ø±Ø³Ø§Ù„ØªÙƒ ÙÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ø©!*\n\n` +
        `ğŸ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${result.reward} ZAAR ÙƒÙ…ÙƒØ§ÙØ£Ø©!\n\n` +
        `Ø´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª: /lake`,
      { parse_mode: 'Markdown' }
    );
  }
});

// Ø§Ù„Ø£Ù…Ø±: /help - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
bot.command('help', async (ctx) => {
  const helpText = `
â“ *Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©* â“

ğŸ® *Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:*
â€¢ /start - Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
â€¢ /mine - Ø§Ù„Ø­ÙØ± (15 Ø«Ø§Ù†ÙŠØ©)
â€¢ /stats - Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ
â€¢ /evolve - Ø§Ù„ØªØ·ÙˆØ± (Ø¹Ù†Ø¯ 1000 ZAAR)

ğŸŒŠ *Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©:*
â€¢ /lake - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
â€¢ /post Ø±Ø³Ø§Ù„Ø© - Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ø©

ğŸ“– *ÙƒÙŠÙ ØªÙ„Ø¹Ø¨:*
1ï¸âƒ£ Ø§Ø­ÙØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… /mine
2ï¸âƒ£ Ø§Ø¬Ù…Ø¹ 1000 ZAAR
3ï¸âƒ£ ØªØ·ÙˆØ± Ø¥Ù„Ù‰ Ø£Ø³Ø¯ Ø¨Ù€ /evolve
4ï¸âƒ£ Ø´Ø§Ø±Ùƒ ÙÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ø© Ø¨Ù€ /post

ğŸ’¡ *Ù†ØµØ§Ø¦Ø­:*
â€¢ Ø§Ù„Ø£Ø³Ø¯ ÙŠØ­ÙØ± Ø¶Ø¹Ù Ø§Ù„Ø´Ø¨Ù„
â€¢ Ø§Ù„Ø·Ø§Ù‚Ø© ØªØªØ¬Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
â€¢ Ø§Ù„Ù†Ø´Ø± ÙŠØ¹Ø·ÙŠÙƒ ZAAR Ø¥Ø¶Ø§ÙÙŠØ©
â€¢ Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø¶Ø¨Ø§Ø¹ ÙŠÙ‚Ù„Ù„ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¥Ø°Ø§ Ø­ÙØ±Øª ÙƒØ«ÙŠØ±Ø§Ù‹

ğŸ¦‰ *Ø§Ù„Ø¨ÙˆÙ…Ø© ØªÙ‚ÙˆÙ„:*
"Ø§Ù„ØµØ¨Ø± Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ø¬Ø§Ø­! ğŸŒŸ"
`;

  await ctx.replyWithMarkdown(helpText);
});

// Ø²Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
bot.hears('â“ Ù…Ø³Ø§Ø¹Ø¯Ø©', (ctx) => ctx.telegram.sendMessage(ctx.chat.id, '/help'));

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
bot.catch((err, ctx) => {
  console.error('Bot error:', err);
  ctx.reply('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
});

// ============================================
// ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
// ============================================
console.log('ğŸ¦ Starting LAST Token Bot...');

bot.launch()
  .then(() => {
    console.log('âœ… Bot is running!');
    console.log('ğŸ“Š Database loaded');
    console.log('ğŸ® Game engine ready');
    console.log('\nğŸ”— Open Telegram and chat with your bot!');
  })
  .catch((error) => {
    console.error('âŒ Failed to start bot:', error);
  });

// Ø¥ÙŠÙ‚Ø§Ù Ø¢Ù…Ù†
process.once('SIGINT', () => {
  console.log('\nğŸ›‘ Stopping bot...');
  bot.stop('SIGINT');
  db.save();
  console.log('âœ… Database saved');
  console.log('ğŸ‘‹ Goodbye!');
});

process.once('SIGTERM', () => {
  bot.stop('SIGTERM');
  db.save();
});
